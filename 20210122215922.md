### 前端
test
#### jQuery

基础内容查看jQuery笔记

![image-20210116100918022](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210116100918022.png)

- ES6新增了`let`命令，用来声明变量。它的用法类似于`var`，但是所声明的变量，只在`let`命令所在的代码块内有效
- val() - 设置或返回表单字段的值

**CDN 引入**

```html
<head>
<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js">
</script>
</head>
```
#### 例：search搜索

```html
{% block middle %}
    <p>
    <input type="text" placeholder="search" name="search">
    <input type="button" value="search" id="search">
    </p>

    <table border="1" cellspacing="0" id="table1">
        <tr>
            <td>index</td>
            <td>username</td>
            <td>phone</td>
            <td>datatime</td>
            <td>action</td>

        </tr>
        {% for user in users %}
        <tr>
            <td>{{ loop.index }}</td>
            <td>{{ user.username }}</td>
            <td>{{ user.phone }}</td>
            <td>{{ user.rdatetime }}</td>
            <td>
                <a href="javascript:;">update</a>
                <a href="javascript:;">delete</a>
            </td>
        </tr>
        {% endfor %}
    </table>

    {% block js %}
        <script>
            $('#search').click(
                //因为#search是上边search按钮的id标签选择器名
                function () {
                    let content = $("input[name='search']").val()  
                    //所声明的变量，只在let命令所在的代码块内有效
                    //#input[name='search]使用这个进行选择的原因：找到对应元素
                    //<-元素选择器   标签选择器->let content = $("#input[name='search']").val()要提前指定id   
                    // 类选择器$("#input[name='search']").val()

                    alert(content);
                }
                )
        </script>

    {% endblock %}

{% endblock %}
```

![image-20210118092538197](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210118092538197.png)

#### 例：标签选择栏

![1](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5C1-1611280228370.gif)

![image-20210122085414331](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210122085414331.png)

```html
{% block scripts %}
    {{ super() }}
    <script>
        $(document).ready(function () {
            $('#div2').hide()
            $('#div1').show()
            $('#passwordlogin').addClass('active')
        })
        $('#passwordlogin').click(function () {
            $('#div2').hide()
            $('#div1').show()
            $('#passwordlogin').addClass('active')
            $('#codelogin').removeClass('active')
        })
        $('#codelogin').click(function () {
            $('#div1').hide()
            $('#div2').show()
            $('#codelogin').addClass('active')
            $('#passwordlogin').removeClass('active')
        })
    </script>
{% endblock %}
```

#### submit和button的区别

> 一、submit
>
> 1、提交按钮，点击之后直接将数据提交的服务器端。
>
> 2、使用submit后，页面支持键盘enter键操作。
>
> 3、submit需要有表单时，提交时才会带数据。
>
> 4、当有表单的时候，如果提交的数据很多，那么使用submit比button要好，可以减少很多数据的获取动作，但是要记得表单提交的数据要验证。
>
> 二、button
>
> 简单的按钮，有按钮的一些事务处理，有脚本就通过脚本将参数传过去。
>
> button默认是不提交任何数据。
>
> 如果没有表单的话，又想通过提交某些数据给后台进行回应，则需要通过button，当然使用submit也可以，但是前提要拦截onclick事件。

#### table标签

https://www.w3school.com.cn/tags/tag_th.asp

- table 表格
- tr 行
- th  定义表格内的表头单元格
- td  单元格

#### label标签

<label> 标签为 input 元素定义标注（标记）

<label> 标签的 for 属性应当与相关元素的 id 属性相同

```html
<form>
  <label for="male">Male</label>
  <input type="radio" name="sex" id="male" />
  <br />
  <label for="female">Female</label>
  <input type="radio" name="sex" id="female" />
</form>
```

#### Bootstrap

Bootstrap 是一个用于快速开发 Web 应用程序和网站的前端框架，Bootstrap 是基于 HTML、CSS、JAVASCRIPT 的

文档：https://v3.bootcss.com/getting-started/

与前端相关优质项目

- React   用于构建用户界面的 JavaScript 框架

- svelte   Svelte 是构建 Web 应用程序的一种新方法

- nodejs  Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境

- npm  NPM（node package manager）是 Node.js 世界的包管理器

- vue.js  Vue.js - 是一套构建用户界面的渐进式框架

- Markdown  Markdown 是一种轻量级标记语言

**Bootstrap CDN**

  ```html
<!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- 可选的 Bootstrap 主题文件（一般不用引入） -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  ```

**Flask插件**

Flask-Bootstrap 不支持 Bootstrap4

Bootstrap-Flask 轻量级代替品

这两个不能共存

使用需要安装，注意是虚拟环境，安装后就不需要下载bootstrap或者使用cdn了

```bash
pip install  -i https://pypi.tuna.tsinghua.edu.cn/simpletensorflow
```

**使用 Flask-Bootstrap**

配置初始化Flask

```python
#ext/__init__.py
from flask_bootstrap import Bootstrap
bootstrap=Bootstrap()

#apps/__init__.py
from ext import db, bootstrap
create_app()
	# 初始化bootstrap
    # db.init_app(app=app) 和数据库db的格式相同
    bootstrap.init_app(app=app)
```

继承

```jinja2
{#base.html#}
{% extends 'bootstrap/base.html' %}
{% block title %}
index
{% endblock %}
```

内置 block 块

- title

- navbar

- content

- styles

- scripts

- head

- body


**简单实例**

![image-20210120212522879](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210120212522879-1611193231165.png)

```html
{% extends "bootstrap/base.html" %}

{% block title %}Flasky{% endblock %}

{% block navbar %}
<div class="navbar navbar-inverse" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/user/register">register</a>
        </div>
        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="/">login</a></li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
    {% block mycontent %}
    
    {% endblock %}
<div class="container">
    <div class="page-header">
    {% block page_content %}{% endblock %}
    </div>
</div>
{% endblock %}
```

#### Ajax

异步 JavaScript 和 XML

jQuery load() 方法

```js
$(selector).load(URL,data,callback);
#
必需的 URL 参数规定您希望加载的 URL。
可选的 data 参数规定与请求一同发送的查询字符串键/值对集合。
可选的 callback 参数是 load() 方法完成后所执行的函数名称。
```

实例：实现用户注册手机号信息判断

![1](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5C1-1611199736305.gif)

templates/register.html

```html
......
{% block scripts %}
    {{ super() }}
    <script>
        {#当输入域失去焦点 (blur) #}
        $('#inputPhone').blur(function () {
            let phone = $(this).val();
            let span_ele = $(this).next('span');
            if (phone.length == 11){
                span_ele.css({"color":"#ff0011", "font-size": "12px"})
                span_ele.text('')
                $.get('{{ url_for('user.check_phone') }}',{phone:phone},function (data){
                {#  data为返回数据  #}
                    if(data.code != 200){
                        span_ele.text('用户已注册')
                    }
                })
            }
            else{
                span_ele.css({"color":"#ff0011", "font-size": "12px"})
                {#注意是字典格式#}
                span_ele.text('手机号长度有误')
            }
        })
    </script>
{% endblock %}
```

apps/user/view.py

```python
......
@user_bp.route('check_phone', methods=['GET', 'POST'], endpoint='check_phone')
def check_phone():
    phone = request.args.get('phone')
    user = User.query.filter(User.phone == phone).all()
    print(user)
    # code：200可用  400不可用
    if len(user) > 0:
        return jsonify(code=400)
    else:
        return jsonify(code=200)
    # ajax 返回的数据必须是 json 格式   jsonify()内部封装了 json.dumps()
    
#或者：
    if len(user) > 0:
        code=400
    else:
        code=200
    return jsonify(code=code)
只要是每一种逻辑都有对应 return 不至于找不到返回内容即可
```

### 用户操作

```html
<!--show.html-->
<tr>
    <td>{{ loop.index }}</td>
    <td>{{ user.username }}</td>
    <td>{{ user.phone }}</td>
    <td>{{ user.rdatetime }}</td>
	<td>
    <a href="{{ url_for('user.update') }}?id={{ user.id }}">update</a>
	<a href="{{ url_for('user.delete') }}?id={{ user.id }}">delete</a>
     {#错误写法 <a href="/{{ url_for('user.delete') }}?id={{ user.id }}">delete</a> #}
     {# 这样写他就找 / #}
</tr>
```

![image-20210119103919569](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210119103919569.png)

#### 查询

![image-20210119142433502](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210119142433502.png)

```html
<div>
    <p>
    <input type="text" placeholder="search" name="search">
    <input type="button" value="search" id="search">
    </p>
</div>
```

```python
# view.py
@user_bp.route('/search', endpoint='search')
def user_search():
    if request.args.get('search'):
        keyword = request.args.get('search')

        user_list = User.query.filter(or_(User.username.contains(keyword), User.username.contains(keyword))).all()
        # 查询手机号或者用户名
        return render_template('user/show.html', users=user_list)
    else:
        return redirect(url_for('user.show'))
```

#### 逻辑删除

就相当于更新，在数据库里添加isdelete字段进行判断

```python
#model.py
from datetime import datetime
from ext import db

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    username = db.Column(db.String(15), nullable=False)
    password = db.Column(db.String(64), nullable=False)
    phone = db.Column(db.String(11), unique=True)
    rdatetime = db.Column(db.DateTime, default=datetime.now)
    isdelete = db.Column(db.Boolean, default=False)
    # 逻辑删除字段
```

```python
#view.py
@user_bp.route('/delete', endpoint='delete')
def user_delete():
    id = request.args.get('id')
    user = User.query.get(id)
    user.isdelete = True
    db.session.commit()
    return redirect(url_for('user.show'))

@user_bp.route('/show', endpoint='show')
def user_show():
    users = User.query.filter(User.isdelete == False).all()
    return render_template('user/show.html', users=users)
```

删除后数据库里依然有数据

bug：注册用户时手机号因为是unqiue的，如果手机号重复会报错

解决：注册时加一层数据库查询手机号，如果手机号存在则更新用户其他数据

#### 物理删除

```python
@user_bp.route('/delete', endpoint='delete')
def user_delete():
    id = request.args.get('id')
    user = User.query.get(id)
    db.session.delete(user)
    db.session.commit()
    return redirect(url_for('user.show'))
```

不需要单独设置 isdelete 列

#### 更新用户

```python
#view.py
@user_bp.route('/update', endpoint='update', methods=['GET', 'POST'])
def user_update():
    if request.method == 'POST':
        id = request.form.get('id')
        new_user = User.query.get(id)
        new_user.username = request.form.get('new_username')
        new_user.password = request.form.get('new_password')
        new_user.phone = request.form.get('new_phone')
        # 只有添加数据是用 db.sesson.add()
        db.session.commit()
        return redirect(url_for('user.show'))
    else:
        id = request.args.get('id')
        user = User.query.get(id)
        return render_template('user/update.html', user=user)
```

```html
<!--update.html-->
{% extends 'base.html' %}

{% block middle %}
    <form action="{{ url_for('user.update') }}" method="post">
        <p><input type="hidden" name="id" value="{{ user.id }}"></p>
                {# 隐藏表单提交用户id #}
        <p><input type="text" name="new_username" value="{{ user.username }}"></p>
        <p><input type="text" name="new_password" placeholder="new password"></p>
        <p><input type="text" name="new_phone" value="{{ user.phone }}"></p>
        <p><input type="submit" value="submit"></p>
    </form>
{% endblock %}
```

### 多表关系

文档：http://www.pythondoc.com/flask-sqlalchemy/models.html#one-to-many

表与表间的关系可能十分复杂

####　外键

外键表示了两个关系之间的相关联系，以另一个关系的外键作主关键字的表被称为主表，具有此外键的表被称为主表的从表，外键又称作外关键字![image-20210119145824052](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210119145824052.png)

```python
user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
```

![image-20210119184316860](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210119184316860.png)

外键是从表中的一个字段

#### 一对多

one to many![image-20210119210440785](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210119210440785.png)项目完成总览![image-20210119201054575](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210119201054575.png)

user/model.py

```python
from datetime import datetime
from ext import db

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    username = db.Column(db.String(15), nullable=False)
    password = db.Column(db.String(64), nullable=False)
    phone = db.Column(db.String(11), unique=True)
    email = db.Column(db.String(25))
    icon = db.Column(db.String(40))
    isdelete = db.Column(db.Boolean, default=False)
    rdatetime = db.Column(db.DateTime, default=datetime.now)

    articles = db.relationship('Article', backref='user')
    # 用于反向查找，实际不会添加到数据库中，相当于把两张表连起来
    # 和外键匹配
    # Article 为模型名大写
    # user小写因为表名在数据库中为小写
```
article/model.py
```python
from datetime import datetime

from ext import db


class Article(db.Model):
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    title = db.Column(db.String(100), nullable=False)
    content = db.Column(db.Text, nullable=False)
    pdatetim = db.Column(db.DateTime, default=datetime.now)
    click_num = db.Column(db.Integer, default=0)
    save_num = db.Column(db.Integer, default=0)
    love_num = db.Column(db.Integer, default=0)

    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    # 外键，这个字段会添加数据库中
```
```python
@article_bp.route('/all')
def all_article():
    articles = Article.query.all()
    return render_template('article/all.html', articles=articles)


@article_bp.route('/all1')
def all_by_id():
    id = request.args.get('id')
    users = User.query.get(id)
    return render_template('article/all1.html', users=users)
```

article/add_article.html

```html
<form action="{{ url_for("article.publish") }}" method="post">
    <p><input type="text" name="title" placeholder="文章标题"></p>
    <p><textarea cols="50" rows="10" name="content" placeholder="输入文章内容"></textarea></p>
    <p>
        user:
        <select name="uid">
            <option value="0">please select user</option>
            {% for user in users %}
                <option value="{{ user.id }}">{{ user.username }}</option>
            {% endfor %}
        </select>
    </p>
    <p><input type="submit" value="add article"></p>
</form>
```

article/all.html

```html
<!--文章->查user.username-->
{% for article in articles %}
<div id="article">
<p>
    <h3>{{ article.title }}</h3>
    <div>作者：{{ article.user.username }}</div>
            {#  backref 反向引用  #}
    <p>
        {{ article.content }}
    </p>
    <div>{{ article.pdatetime }}</div>
</p>
</div>
{% endfor %}
```

article/all1.html

```jinja2
{#根据用户id找文章#}
{% for article in users.articles %}
<div id="article">
<h1>
    {{ article.title }}
</h1>
<div>
    {{ users.username }}
</div>
<p>
    {{ article.content }}
</p>
<p>
    {{ article.pdatetim }}
</p>
</div>
{% endfor %}
```

#### 多对多

many to many

![image-20210119210342498](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210119210342498.png)

![image-20210120090256933](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210120090256933.png)

可以通过中间表建立关系

#### pycharm查看表关系

首先选择多个表->diagrams->show

#### 多对多实例：用户与商品

功能：用户和商品展示，用户购卖商品，根据商品找用户，根据用户找商品![1](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5C1.gif)

![image-20210120144631854](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210120144631854.png)

上图为实际表关系

apps/goods/model.py

```python
from apps.user.model import User
from ext import db

class Goods(db.Model):
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    gname = db.Column(db.String(100), nullable=False)
    price = db.Column(db.Float, nullable=False)
    # back reference
    users = db.relationship('User', backref='goodslist', secondary='user_goods')
    # relationship 定义的字段不会填入数据库，是给view和template定义的
    # users和User表建立联系但是没有外键，所以需要 secondary适用于多对多情况
    # Goods可以通过 Goods.users.xxx 查users表  反向：users.googlist.xxx查Goods表
    # relationship 定义在Goods表或User表都可以，只是需要改值

# 中间表 添加表不需要执行 python app.py db init 此命令尽在没有migrations文件夹时需执行,添加字段也是migrate即可
class User_goods(db.Model):
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    goods_id = db.Column(db.Integer, db.ForeignKey(Goods.id), nullable=False)
    num = db.Column(db.Integer, default=0)
```

apps/user/model.py

```python
from datetime import datetime
from ext import db


class User(db.Model):
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    username = db.Column(db.String(15), nullable=False)
    password = db.Column(db.String(64), nullable=False)
    phone = db.Column(db.String(11), unique=True)
    email = db.Column(db.String(25))
    icon = db.Column(db.String(40))
    isdelete = db.Column(db.Boolean, default=False)
    rdatetime = db.Column(db.DateTime, default=datetime.now)

#或者在此添加    #goods=db.relationship('Goods',backref='userlist',secondary='user_goods')
```

apps/goods/view.py

```python
from flask import Blueprint, render_template, request
from apps.goods.model import Goods, User_goods
from apps.user.model import User
from ext import db

goods_bp = Blueprint('goods', __name__)


@goods_bp.route('/')
def goods_index():
    users_list = User.query.all()
    goods_list = Goods.query.all()
    return render_template('goods/show.html', users_list=users_list, goods_list=goods_list)


@goods_bp.route('/buy')
def goods_buy():
    ug = User_goods()
    # 先创建 User_goods 的实例化对象
    ug.user_id = request.args.get('uid')
    ug.goods_id = request.args.get('gid')
    db.session.add(ug)
    # 添加 ug 对象到缓存中
    db.session.commit()
    return 'add ok'


# 根据商品找用户
@goods_bp.route('/finduser', endpoint='finduser')
def find_user():
    goods_id = request.args.get('gid')
    goods = Goods.query.get(goods_id)
    return render_template('goods/finduser.html', goods=goods)


# 根据用户找商品
@goods_bp.route('/findgoods', endpoint='findgoods')
def find_goods():
    user_id = request.args.get('uid')
    users = User.query.get(user_id)
    return render_template('goods/findgoods.html', users=users)
```

![image-20210120105426370](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210120105426370.png)

templates/goods/show.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>show</title>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <style>
        #goods_table tr td{
            width: 100px;
            background-color: cornflowerblue;
        }
    </style>
</head>

<body>
<div>
<form>
    <p>
        {#展示用户#}
        <select name="uid" >
            <option value="0">please select user</option>
            {% for users in users_list %}
                <option value="{{ users.id }}">{{ users.username }}</option>
            {% endfor %}
        </select>
    </p>

    {#展示商品#}
    <table border="1px solid" cellspacing="0" id="goods_table" style="text-align: center">
        <tr>
            <th>index</th>
            <th>goods</th>
            <th>price</th>
            <th>action</th>
        </tr>
        {% for goods in goods_list %}
            <tr>
                <td>{{ loop.index }}</td>
                <td><a href="{{ url_for('goods.finduser') }}?gid={{ goods.id }}">{{ goods.gname }}</a></td>
                    {# 建立超链接 #}
                <td>{{ goods.price }}</td>
                <td><input type="button" class="btngoods" value="buy" tag="{{ goods.id }}"></td>
                {#  通过tag标签把goods.id值传给view  #}
            </tr>
        {% endfor %}
    </table>
</form>
</div>

<script>
    $('.btngoods').click(function () {
        goods_id = $(this).attr('tag');
        user_id = $("select[name='uid']").val();
        {#  css选择器 选择具有值为uid的name属性的select标签 注意引号  #}
        location.href='/buy?uid='+user_id+'&'+'gid='+goods_id;
    })
</script>
</body>
</html>
```

templates/goods/finduser.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>finduser</title>
</head>
<body>
<div>
    <h3>{{ goods.gname }}</h3>
    <br>
        {% for user in goods.users %}
            <p>
                <a href="{{ url_for('goods.findgoods') }}?uid={{ user.id }}">{{ user.username }}</a>
            </p>
        {% endfor %}
</div>
</body>
</html>
```

templates/goods/findgoods.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>findgoods</title>
</head>
<body>
<div>
    <h3>{{ users.username }}</h3>
</div>
    {% for goods in users.goodslist %}
    <p>{{ goods.gname }}------{{ goods.price }}</p>
    {% endfor %}
</body>
</html>
```

app.py

```python
from apps.user.model import User
from apps.article.model import Article
from apps.goods.model import *
# 一定要将表对象在此引用否则无法在数据库生成表
```

#### 多对多实例2：用户，文章，评论

![image-20210119140831577](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210119140831577.png)

```python
from datetime import datetime
from apps.user.model import User
from ext import db


class Atype(db.Model):
    __tablename__ = 'A_type'
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    type_name = db.Column(db.String(25), nullable=False)
    articles = db.relationship('Article', backref='typename')


class Article(db.Model):
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    title = db.Column(db.String(100), nullable=False)
    content = db.Column(db.Text, nullable=False)
    pdatetim = db.Column(db.DateTime, default=datetime.now)
    click_num = db.Column(db.Integer, default=0)
    save_num = db.Column(db.Integer, default=0)
    love_num = db.Column(db.Integer, default=0)
    type_id = db.Column(db.Integer, db.ForeignKey('A_type.id'))
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'))

    comments = db.relationship('User', backref='articles')


class Comment(db.Model):
    # 自定义表名
    __tablename__ = 'comment'

    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    comment = db.Column(db.String(255), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'))
    article_id = db.Column(db.Integer, db.ForeignKey('article.id'))
    # 注意 db.ForeignKey() 格式
    cdatetime = db.Column(db.DateTime, default=datetime.now)

    def __str__(self):
        return self.comment
```

注意：用pycharm查看时 atype 没有连起来（可能没成功建立起外键关系），试了很多次都是这样

![image-20210120181746326](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210120181746326.png)

### ELSE

#### 补充蓝图

```python
#apps/user/__init__.py
user_bp = Blueprint('user', __name__, url_prefix='/user')

@user_bp.route('/', endpoint='index')
def index():
    return 'index'

#添加url_prefix后
Map([<Rule '/user/' (HEAD, OPTIONS, GET) -> user.index>,
 <Rule '/static/<filename>' (HEAD, OPTIONS, GET) -> static>])

# url_prefix='/user' 必须是加 / 
ValueError: urls must start with a leading slash
```

![image-20210120193027022](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210120193027022.png)

#### 数据加密

除了 hashlib 库，Flask 自带了hash加盐加密方法

**加密：generate_password_hash**

```python
from werkzeug.security import generate_password_hash

#generate_password_hash(password,method='pbkdf2:sha256',salt_length=*)

user.password = generate_password_hash(password)

# 数据格式：method$salt$hash
```

注意：加密后长度是变化的，所以数据库 password 字段要注意长度

Flask 由于封装问题修改数据字段长度在进行 migrate 会显示 not update，Flask 只能是添加删除数据库字段可会显示有更新，可以通过 pycharm 更改

Django 都可以

**密码匹配：check_password_hash**

```python
@user_bp.route('/login', methods=['GET', 'POST'], endpoint='login')
def user_login():
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        users = User.query.filter(User.username == username).all()
        for user in users:
            flag = check_password_hash(user.password, password)
            # flask 封装检查password函数，返回值bool类型，匹配为Ture，否则为False
            #user.password 为加密过的密码，password 为未加密密码
            if flag:
                return jsonify(msg='登录成功', code=200)
        else:
            return jsonify(msg='登录失败', code=400)
    else:
        return render_template('user/login.html')
```

### 会话机制

记录用户登陆状态

HTTP是无状态协议

Cookie，Session

#### Cookie

保存

```python
# 通过 response 对象保存
response = redirect(xxx)
response = render_template(xxx)
response = Response()
response = make_response(xxx)
response = jsonify(xxx)
# 通过对象调用方法
response.set_cookie(key,value,max_age)

set_cookie(属性)
#属性
name		cookie的名称
value		cookie的值
expire		过期时间
path		有效路径
domain		域名
secure		https专用 true为安全传输
httponly	仅通过http协议访问，不能通过js

#例：
@user_bp.route('/login', methods=['GET', 'POST'], endpoint='login')
def user_login():
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        users = User.query.filter(User.username == username).all()
        for user in users:
            flag = check_password_hash(user.password, password)
            # flask 封装检查password函数，匹配为Ture，否则为False
            if flag:
                response = redirect(url_for('user.index'))
                # 需要先创建一个 response 对象
                response.set_cookie(key='username', value=username, max_age=1800)
                return response
        else:
            return render_template('user/login.html', msg='登陆失败')
    else:
        return render_template('user/login.html')
```

获取

```python
# 通过 request 对象获取
request.form.get()
request.args.get
cookie也在 request 对象中
request.cookies.get(key) --->  value

#例：
@user_bp.route('/', endpoint='index')
def index():
    username = request.cookies.get('username')
    return render_template('user/index.html', username=username)
```

删除

```python
# 通过 response 对象删除
response = redirect(xxx)
response = render_template(xxx)
response = Response()
response = make_response(xxx)
response = jsonify(xxx)
# 通过对象调用方法
response.delete_cookie(key)

#例：
@user_bp.route('/logout',endpoint='logout')
def user_logout():
    response=redirect(url_for('user.login'))
    response.delete_cookie('username')
    return response
```

#### Session

在服务器保存，字典类型

cookie，session结合使用，cookie存储session_id，具体数据存储在session

需要设置 setting.py

SECRET_KEY = 'xxxxx'

xx这个值自己定义即可，目的是用于 sessionid 的加密

```python
#例：settings.py
class Config:
    SQLALCHEMY_DATABASE_URI = 'mysql+pymysql://root:root@127.0.0.1:3306/flask'
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    SQLALCHEMY_ECHO = True
    SECRET_KEY='fdsajfidposajgiopds'
```

设置：

```python
若果要使用session，需要直接导入：
from flask import session

session[key]=value
会将key=value保存到session内存空间中

#例
@user_bp.route('/login', methods=['GET', 'POST'], endpoint='login')
def user_login():
	......
    session['username'] = username
    return redirect(url_for('user.index'))
	......
```

获取

```python
value = session[key] 或 value = session.get(key)

#例：
@user_bp.route('/', endpoint='index')
def index():
    username = session['username']
    return render_template('user/index.html', username=username)
```

清除

```python
session.clear()		删除session内存空间和删除cookie，（常用）

del session[key]		只会删除session中的这个键值对，不会删除session空间和cookie

# 例
@user_bp.route('/logout', endpoint='logout')
def user_logout():
    session.clear()
    return redirect(url_for('user.index'))
```

### 手机验证码

云短信服务 SMS（Short Message Service，SMS）

可以找各家提供的免费赠送的部分

![image-20210122102133931](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210122102133931.png)

网易开发文档：https://support.dun.163.com/documents/2018101001?docId=210168759616458752

控制台：https://dun.163.com/dashboard#/m/sms/index/?pid=YD00030772740753

查看凭证

![image-20210122091759603](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210122091759603.png)

签名需要实名认证审核

![image-20210122091602427](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210122091602427.png)

![image-20210122091449899](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210122091449899.png)

#### 例：手机验证码登录

具体页面效果

![1](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5C1-1611293670313.gif)

taskId的调用-使用session实现

![image-20210122133611694](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210122133611694.png)

apps/user/smssend.py ---sms开发文档中有

```python
from hashlib import md5
import json
import random
import time
import urllib
import urllib.request


class SmsSendAPIDemo(object):
    """易盾短信发送接口示例代码"""
    API_URL = "https://sms.dun.163.com/v2/sendsms"
    VERSION = "v2"

    def __init__(self, secret_id, secret_key, business_id):
        """
        Args:
            secret_id (str) 产品密钥ID，产品标识
            secret_key (str) 产品私有密钥，服务端生成签名信息使用
            business_id (str) 业务ID，易盾根据产品业务特点分配
        """
        self.secret_id = secret_id
        self.secret_key = secret_key
        self.business_id = business_id

    def gen_signature(self, params=None):
        """生成签名信息
        Args:
            params (object) 请求参数
        Returns:
            参数签名md5值
        """
        buff = ""
        for k in sorted(params.keys()):
            buff += str(k) + str(params[k])
        buff += self.secret_key
        return md5(buff.encode("utf-8")).hexdigest()

    def send(self, params):
        """请求易盾接口
        Args:
            params (object) 请求参数
        Returns:
            请求结果，json格式
        """
        params["secretId"] = self.secret_id
        params["businessId"] = self.business_id
        params["version"] = self.VERSION
        params["timestamp"] = int(time.time() * 1000)
        params["nonce"] = int(random.random() * 100000000)
        params["signature"] = self.gen_signature(params)

        try:

            params = urllib.parse.urlencode(params)
            params = params.encode('utf-8')
            request = urllib.request.Request(self.API_URL, params)
            content = urllib.request.urlopen(request, timeout=5).read()
            return json.loads(content)
        except Exception as ex:
            print("调用API接口失败:", str(ex))
```

apps/user/view.py       主要逻辑功能实现

```python
import hashlib
from flask import Blueprint, render_template, request, url_for, redirect, jsonify, session
from werkzeug.security import generate_password_hash, check_password_hash

from apps import db
from apps.user.model import User
from apps.user.smssend import SmsSendAPIDemo

user_bp = Blueprint('user', __name__, url_prefix='/user')


@user_bp.route('/', endpoint='index')
def index():
    uid = session.get('uid')
    # 如果没有 uid 对应的值，也就是取不到的话值为 None
    if uid:
        user = User.query.get(uid)
        return render_template('user/index.html', user=user)
    return render_template('user/index.html')


@user_bp.route('/center', endpoint='center')
def center():
    uid = session.get('uid')
    if uid:
        user = User.query.get(uid)
        return render_template('user/center.html', user=user)
    return render_template('user/center.html')


@user_bp.route('/register', methods=['GET', 'POST'], endpoint='register')
def register():
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        repassword = request.form.get('repassword')
        phone = request.form.get('phone')
        email = request.form.get('email')
        print(email)
        if password == repassword:
            user = User()
            user.username = username
            user.password = generate_password_hash(password)
            user.phone = phone
            user.email = email
            db.session.add(user)
            db.session.commit()
            return 'ok'
        else:
            return 'password is diff'
    else:
        return render_template('user/register.html')


@user_bp.route('/check_phone', methods=['GET', 'POST'], endpoint='check_phone')
def check_phone():
    phone = request.args.get('phone')
    user = User.query.filter(User.phone == phone).all()
    print(user)
    # code：200可用  400不可用
    if len(user) > 0:
        code = 400
    else:
        code = 200
    return jsonify(code=code)
    # ajax 返回的数据必须是 json 格式   jsonify()内部封装了 json.dumps()


@user_bp.route('/login_check_phone', methods=['GET', 'POST'], endpoint='login_check_phone')
def login_check_phone():
    phone = request.args.get('phone')
    user = User.query.filter(User.phone == phone).all()
    print(user)
    # code：200已注册  400未注册
    if len(user) > 0:
        code = 200
    else:
        code = 400
    return jsonify(code=code)
    # ajax 返回的数据必须是 json 格式   jsonify()内部封装了 json.dumps()


@user_bp.route('/login', methods=['GET', 'POST'], endpoint='login')
def user_login():
    if request.method == 'POST':
        # f=1 账户密码登录   f=2 手机号验证码登录
        if request.args.get('f') == '1':
            username = request.form.get('username')
            password = request.form.get('password')
            users = User.query.filter(User.username == username).all()
            for user in users:
                flag = check_password_hash(user.password, password)
                # flask 封装检查password函数，匹配为Ture，否则为False
                if flag:
                    session['uid'] = user.id
                    return redirect(url_for('user.center'))
            else:
                return render_template('user/login.html', msg='登陆失败')

        elif request.args.get('f') == '2':
            # '2' 一定要加引号,因为request.args.get('f')接受的是字符串类型
            phone = request.form.get('phone')
            code = request.form.get('code')
            valid_code = session.get('code')
            if code == valid_code:
                # 先验证 验证码是否正确
                user = User.query.filter(User.phone == phone).first()
                if user:
                    session['uid'] = user.id
                    return redirect(url_for('user.center'))
            else:
                return render_template('user/login.html', msg='验证码有误')
        else:
            return 'request params is worry'

    else:
        return render_template('user/login.html')


@user_bp.route('/logout', endpoint='logout')
def user_logout():
    session.clear()
    return redirect(url_for('user.login'))


@user_bp.route('/send_code', endpoint='send_code')
def send_code():
    # phone = request.args.get('phone')
    # SECRET_ID = "05c6ee1b7319dfd6aad7e2c51b00cc73"  # 产品密钥ID，产品标识
    # SECRET_KEY = "7042637886876a15101994b371f169d3"  # 产品私有密钥，服务端生成签名信息使用，请严格保管，避免泄露
    # BUSINESS_ID = "225e296526b24078887d47a06dd234b7"  # 业务ID，易盾根据产品业务特点分配
    # api = SmsSendAPIDemo(SECRET_ID, SECRET_KEY, BUSINESS_ID)
    # params = {
    #     "mobile": "your mobile",
    #     "templateId": "10084",
    #     "paramType": "json",
    #     "params": "json格式字符串"
    #     # 国际短信对应的国际编码(非国际短信接入请注释掉该行代码)
    #     # "internationalCode": "对应的国家编码"
    # }
    # ret = api.send(params)
    session['code'] = '12345'
    return jsonify(code=200, msg='短信发送成功')
    # if ret is not None:
    #     if ret["code"] == 200:
    #         taskId = ret["data"]["taskId"]
    #         # 收到验证码 taskId 是局部变量 login() 没法调用
    #         # 如果将 taskId 设为全局变量多用户登录时将存在逻辑问题
    #         session[phone] = taskId
    #         return jsonify(code=200, msg='短信发送成功')
    #     else:
    #         return jsonify(code=400, msg='短信发送失败')
```

templates/user/login.html

```html
{% extends 'base.html' %}

{% block styles %}
    {{ super() }}
    {# 加了super就是继承原有的样式 #}
    <style>
        #container {
            width: 400px;
            margin: 20px auto;
        }
    </style>
{% endblock %}

{% block mycontent %}
    <form class="form-horizontal" id="container" method="post" action="{{ url_for('user.login') }}?f=1">

        <div>
            <ul class="nav nav-tabs" id="loginselect">
                <li role="presentation" id="passwordlogin"><a>账号密码登录</a></li>
                <li role="presentation" id="codelogin"><a>手机验证码登录</a></li>
            </ul>
        </div>
        <br>
        <div id="div1">
            <div class="form-group">
                <label for="inputUsername" class="col-sm-2 control-label">username</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="inputUsername" placeholder="Username" name="username">
                </div>
            </div>

            <div class="form-group">
                <label for="inputPassword" class="col-sm-2 control-label">Password</label>
                <div class="col-sm-10">
                    <input type="password" class="form-control" id="inputPassword" placeholder="Password"
                           name="password">
                </div>
            </div>


            <div class="form-group">
                <div class="col-sm-offset-4 col-md-10">
                    <button type="submit" class="btn btn-default" id="sign">Sign in</button>
                </div>
                <p>{{ msg }}</p>
            </div>
        </div>

    </form>
    <form class="form-horizontal" id="container" method="post" action="{{ url_for('user.login') }}?f=2">
        <div id="div2">
            <div class="form-group">
                <label for="inputphone" class="col-sm-0 control-label"></label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="inputphone" placeholder="phone" name="phone">
                    <span></span>
                </div>
            </div>
            <div class="form-group" style=" float: left ">
                <label for="inputcode" class="col-sm-0  control-label"></label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" col-sm-offset-10 id="inputcode" placeholder="code"
                           name="code">
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-offset-0 col-md-2" style="float: left">
                    <button type="button" class="btn btn-default" id="sendcode" name="code">send code</button>
                        {#  此处type类型未button,点击不提交整个表单,只是触发jquery                  #}
                </div>
            </div>
            <div class="form-group" style="float: left">
                <div class="col-sm-offset-10 col-md-2">
                    <button type="submit" class="btn btn-default" id="codesign">Sign in</button>
                </div>
                <p>{{ msg }}</p>
            </div>
        </div>
    </form>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        $(document).ready(function () {
            $('#div2').hide()
            $('#div1').show()
            $('#passwordlogin').addClass('active')
        })
        $('#passwordlogin').click(function () {
            $('#div2').hide()
            $('#div1').show()
            $('#passwordlogin').addClass('active')
            $('#codelogin').removeClass('active')
        })
        $('#codelogin').click(function () {
            $('#div1').hide()
            $('#div2').show()
            $('#codelogin').addClass('active')
            $('#passwordlogin').removeClass('active')
        })

        $('#inputphone').blur(function () {
            let phone = $(this).val();
            let span_ele = $(this).next('span');
            if (phone.length == 11) {
                span_ele.css({"color": "#ff0011", "font-size": "12px"})
                span_ele.text('')
                $.get('{{ url_for('user.login_check_phone') }}', {phone: phone}, function (data) {
                    {#  data为返回数据  #}
                    if (data.code != 200) {
                        span_ele.text('用户未注册')
                    }
                })
            } else {
                span_ele.css({"color": "#ff0011", "font-size": "12px"})
                {#注意是字典格式#}
                span_ele.text('手机号长度有误')
            }
        })

        $('#sendcode').click(function () {
            let span_ele2 = $(this).next('span');
            let phone = $(this).val();
            $.get('{{ url_for('user.send_code') }}', {phone: phone}, function (data) {
                if (data.code == 200) {
                    alert(data.msg);
                }
                else{
                    alert(data.msg);
                }
            })
        })

    </script>
{% endblock %}
```

templates/user/register.html

```html
{% extends 'base.html' %}

{% block styles %}
    {{ super() }}
    {# 加了super就是继承原有的样式 #}
    <style>
        #container {
            width: 400px;
            margin: 20px auto;
        }
    </style>
{% endblock %}

{% block mycontent %}
    <form class="form-horizontal" id="container" method="post" action="{{ url_for('user.register') }}">
        <div class="form-group">
            <label for="inputUsername" class="col-sm-2 control-label">username</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="inputUsername" placeholder="Username" name="username">
            </div>
        </div>

        <div class="form-group">
            <label for="inputPassword" class="col-sm-2 control-label">Password</label>
            <div class="col-sm-10">
                <input type="password" class="form-control" id="inputPassword" placeholder="Password" name="password">
            </div>
        </div>

        <div class="form-group">
            <label for="inputRePassword" class="col-sm-2 control-label">Confirm Password</label>
            <div class="col-sm-10">
                <input type="password" class="form-control" id="inputRePassword" placeholder="Confirm Password"
                       name="repassword">
            </div>
        </div>

        <div class="form-group">
            <label for="inputPhone" class="col-sm-2 control-label">Phone</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="inputPhone" placeholder="Phone" name="phone">
                <span></span>
            </div>
        </div>

        <div class="form-group">
            <label for="inputEmail" class="col-sm-2 control-label">Email</label>
            <div class="col-sm-10">
                <input type="email" class="form-control" id="inputEmail" placeholder="email" name="email">
            </div>
        </div>

        <div class="form-group">
            <div class="col-sm-offset-4 col-md-10">
                <button type="submit" class="btn btn-default">Sign in</button>
            </div>
        </div>
    </form>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        {#当输入域失去焦点 (blur) #}
        $('#inputPhone').blur(function () {
            let phone = $(this).val();
            let span_ele = $(this).next('span');
            if (phone.length == 11){
                span_ele.css({"color":"#ff0011", "font-size": "12px"})
                span_ele.text('')
                $.get('{{ url_for('user.check_phone') }}',{phone:phone},function (data){
                {#  data为返回数据  #}
                    if(data.code != 200){
                        span_ele.text('用户已注册')
                    }
                })
            }
            else{
                span_ele.css({"color":"#ff0011", "font-size": "12px"})
                {#注意是字典格式#}
                span_ele.text('手机号长度有误')
            }
        })
    </script>
{% endblock %}
```

/center

![image-20210122142257723](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210122142257723.png)

### 权限验证

只要走center路由，就判断用户是否登录，若登录则正常显示，没有登陆的话跳转到登录页面

#### Flask 钩子函数![这里写图片描述](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5C20180706152149799)

- 直接应用在 app 上：

  ```python
  before_first_request
  #在处理第一个请求前运行装饰的要运行的视图函数, 只会执行一次
  
  *before_request
  #在每次请求前运行
  
  after_request
  #如果没有未处理的异常抛出，在每次请求后运行,需要接收一个 Response 类的对象作为参数 并返回一个新的Response 对象 或者 直接返回接受到的Response 对象
  
  teardown_request
  #在每次请求后运行，即使有未处理的异常
  ```

- 应用到蓝图：

  ```python
  before_app_first_request
  
  *before_app_request
  
  after_app_request
  
  teardown_app_request
  ```

以**装饰器**的形式存在

#### flask.g 

 g 对象，本次请求的对象

尽在当次请求中有效

#### 实例

```python
require_login_list = ['/user/center']

@user_bp.before_app_request
def checkveir():
    if request.path in require_login_list:
        uid = session['uid']
        if not uid:
            return redirect(url_for('user.index'))
        else:
            user = User.query.get(uid)
            g.user = user
            
......
@user_bp.route('/center', endpoint='center')
def center():
    uid = session.get('uid')
    if uid:
        user = User.query.get(uid)
        return render_template('user/center.html', user=g.user)
    return render_template('user/center.html')
```



### SSTI

当用户输入被串联到模板中而不是作为数据传递时，服务器端模板注入漏洞就会出现，简单来说也就是不正确的使用flask中的render_template_string方法会引发SSTI

确定模板引擎

常用的方法是使用来自不同模板引擎的语法注入任意数学运算

![图片](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5C640)

ssti

```python
from flask import Flask,render_template_string,request

app = Flask(__name__)
@app.route('/test/')
def test():
    code = request.args.get('id')   //get方式获取id
    html = '''
        <h3>%s</h3>
    '''%(code)
    return render_template_string(html)
#产生原因就是先进行了拼接，在渲染
app.run()
```

这个问题也并非是Jinja2的问题，而且在编写的过程中出现的认为问题

### 文件上传

上传界面html

```html
<form action="{{ url_for('user.change') }}" method="post" enctype="multipart/form-data">
            {#   图片上传必须设置enctype                   #}
    <input type="file" id="exampleInputFile" name="icon">
    <img src="{{ url_for('static',filename='img/1.jpg') }}" alt="" width="90" height="92">
            {#     图片使用固定的引入方式          #}
</form>    
```

print( icon )

![image-20210122214654827](F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5CFlask%E8%BF%9B%E9%98%B6%5Cimage-20210122214654827.png)
